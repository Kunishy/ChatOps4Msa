info:
  version: 1.0.0
  title: sonarqube
  description: SonarQube is an open-source platform used for continuous inspection of code quality.


low_code:
  property:
    sonarqube_token: ${secret.sonarqube_token}
  operation:
    - name: get-sonarqube-technical_debt
      parameter:
        project_name: project name
      description: get project technical debt by SonarQube
      access: public
      body:
        - toolkit-restapi-auth_get:
            url: https://zhao-chatops4msa-sonarqube.soselab.tw/api/measures/component?component=${project_name}&metricKeys=sqale_index,sqale_debt_ratio
            api_token: ${sonarqube_token}
            assign: response
        - toolkit-json-parse:
            json: ${response}
            jsonpath: $.component.measures
            assign: measures_data
        - toolkit-discord-text:
            text: ${project_name}
        - toolkit-list-foreach:
            list: ${measures_data}
            element_name: data
            todo:
              - toolkit-json-parse:
                  json: ${data}
                  jsonpath: $.metric
                  assign: metric_name
              - toolkit-json-parse:
                  json: ${data}
                  jsonpath: $.value
                  assign: value
              - toolkit-discord-text:
                  text: ${metric_name}：${value}
    - name: get-sonarqube-microservice_quality
      parameter:
        microservice_system_name: microservice_system_name
      description: get microservice quality by sonarqube and llm
      access: public
      body:
        # all service
        - toolkit-info-get:
            system: ${microservice_system_name}
            service: all_service
            info: sonarqube_project
            assign: sonarqube_project_list
        - toolkit-flow-value_to_local:
            value: 你是一位軟體品質分析師。根據以下來自系統中多個微服務的 SonarQube 資料，請提供一份綜合性的分析。\n\n請完成以下任務：\n1. 識別哪些微服務具有最高風險。\n2. 建議哪些服務需要立即重構或增加測試。\n3. 總結整體的程式碼品質與可維護性狀況。\n4. 提出具體性的建議不要過於空泛或是開闊的提議。\n\n每個服務都包含以下指標：\n- ncloc：程式碼行數\n- bugs：錯誤數量\n- vulnerabilities：弱點數量\n- code_smells：程式碼異味數量\n- coverage：單元測試覆蓋率（百分比）\n- sqale_index：技術債償還時間（分鐘）\n- sqale_debt_ratio：技術債比例（百分比）\n\n以下是資料：\n\n
            assign: prompt
        - toolkit-string-convert:
            object: ${prompt}
            assign: prompt
        - toolkit-list-foreach:
            list: ${sonarqube_project_list}
            element_name: project_name
            todo:
              # service loop
              - toolkit-restapi-auth_get:
                  url: https://zhao-chatops4msa-sonarqube.soselab.tw/api/measures/component?component=${project_name}&metricKeys=ncloc,bugs,vulnerabilities,coverage,code_smells,sqale_index,sqale_debt_ratio
                  api_token: ${sonarqube_token}
                  assign: response
              - toolkit-string-join:
                  original: ${prompt}
                  join: ${response}
                  assign: prompt
        - toolkit-llm-call:
            prompt: ${prompt}
            prompt_template: none
            assign: response
        - toolkit-discord-text:
            text: ${response}
        - toolkit-discord-text:
            text: ===================================================
    - name: get-sonarqube-metric_explanation
      parameter:
        user_question: user_question
      description: get microservice metric explanation
      access: public
      body:
        - toolkit-flow-value_to_local:
            value: 根據我提供的文檔完整回答問題，不要超出範圍解釋，包含定義、範例、解釋\n\n
            assign: llm_setting
        - toolkit-string-join:
            original: ${user_question}
            join: ${llm_setting}
            assign: prompt
        - toolkit-llm-call:
            prompt: ${prompt}
            prompt_template: sonarqube_measures_and_metrics
            assign: response
        - toolkit-discord-text:
            text: ${response}